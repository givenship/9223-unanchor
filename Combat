-- Combat Module
-- Hitbox adjustment, Aimlock, Team Check, Visibility Check

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local CombatModule = {}
CombatModule.Settings = {
    HitboxEnabled = false,
    HitboxX = 2,
    HitboxY = 2,
    HitboxZ = 2,
    VisibilityCheck = false,
    TeamCheck = false,
    AimlockEnabled = false,
    AimlockSmoothness = 1,
    ShowFOV = false,
    FOVSize = 100
}

local hitboxConnection = nil
local aimlockConnection = nil
local currentTarget = nil
local fovCircle = nil
local originalHitboxSizes = {}

local function createFOVCircle()
    if fovCircle then return end
    
    fovCircle = Drawing.new("Circle")
    fovCircle.Thickness = 2
    fovCircle.NumSides = 64
    fovCircle.Radius = CombatModule.Settings.FOVSize
    fovCircle.Color = Color3.fromRGB(255, 255, 255)
    fovCircle.Transparency = 0.5
    fovCircle.Visible = false
    fovCircle.Filled = false
end

local function updateFOVCircle()
    if not fovCircle then return end
    
    local viewport = Camera.ViewportSize
    fovCircle.Position = Vector2.new(viewport.X / 2, viewport.Y / 2)
    fovCircle.Radius = CombatModule.Settings.FOVSize
    fovCircle.Visible = CombatModule.Settings.ShowFOV and CombatModule.Settings.AimlockEnabled
end

local function isVisible(targetPart)
    if not CombatModule.Settings.VisibilityCheck then return true end
    
    local origin = Camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * 500
    
    local ray = Ray.new(origin, direction)
    local hit, pos = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character, Camera})
    
    if hit then
        return hit:IsDescendantOf(targetPart.Parent)
    end
    
    return false
end

local function isOnSameTeam(player)
    if not CombatModule.Settings.TeamCheck then return false end
    
    if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
        return true
    end
    
    return false
end

local function getClosestPlayerToCursor()
    local closestPlayer = nil
    local shortestDistance = CombatModule.Settings.FOVSize
    
    local viewport = Camera.ViewportSize
    local mousePos = Vector2.new(viewport.X / 2, viewport.Y / 2)
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Team check
            if isOnSameTeam(player) then
                continue
            end
            
            local character = player.Character
            local head = character:FindFirstChild("Head")
            
            if head then
                -- Visibility check
                if not isVisible(head) then
                    continue
                end
                
                local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position)
                
                if onScreen then
                    local screenPosition = Vector2.new(screenPos.X, screenPos.Y)
                    local distance = (screenPosition - mousePos).Magnitude
                    
                    if distance < shortestDistance then
                        shortestDistance = distance
                        closestPlayer = player
                    end
                end
            end
        end
    end
    
    return closestPlayer
end

local function applyHitbox()
    if not CombatModule.Settings.HitboxEnabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Team check
            if isOnSameTeam(player) then
                -- Restore original hitbox if on same team
                if originalHitboxSizes[player] then
                    for partName, originalSize in pairs(originalHitboxSizes[player]) do
                        local part = player.Character:FindFirstChild(partName)
                        if part and part:IsA("BasePart") then
                            part.Size = originalSize
                            part.Transparency = 0
                            part.CanCollide = true
                        end
                    end
                    originalHitboxSizes[player] = nil
                end
                continue
            end
            
            local character = player.Character
            local hrp = character:FindFirstChild("HumanoidRootPart")
            
            if hrp then
                -- Store original size if not already stored
                if not originalHitboxSizes[player] then
                    originalHitboxSizes[player] = {}
                end
                
                if not originalHitboxSizes[player]["HumanoidRootPart"] then
                    originalHitboxSizes[player]["HumanoidRootPart"] = hrp.Size
                end
                
                -- Apply new hitbox size
                hrp.Size = Vector3.new(
                    CombatModule.Settings.HitboxX,
                    CombatModule.Settings.HitboxY,
                    CombatModule.Settings.HitboxZ
                )
                hrp.Transparency = 0.5
                hrp.CanCollide = false
            end
        end
    end
end

local function restoreHitboxes()
    for player, parts in pairs(originalHitboxSizes) do
        if player.Character then
            for partName, originalSize in pairs(parts) do
                local part = player.Character:FindFirstChild(partName)
                if part and part:IsA("BasePart") then
                    part.Size = originalSize
                    part.Transparency = 0
                    part.CanCollide = true
                end
            end
        end
    end
    originalHitboxSizes = {}
end

local function aimlockUpdate()
    if not CombatModule.Settings.AimlockEnabled then return end
    
    local target = getClosestPlayerToCursor()
    
    if target and target.Character then
        local head = target.Character:FindFirstChild("Head")
        
        if head then
            currentTarget = target
            
            local targetPos = head.Position
            local camCFrame = Camera.CFrame
            local targetCFrame = CFrame.new(camCFrame.Position, targetPos)
            
            -- Apply smoothness
            local smoothness = CombatModule.Settings.AimlockSmoothness
            Camera.CFrame = camCFrame:Lerp(targetCFrame, 1 / smoothness)
        end
    else
        currentTarget = nil
    end
end

local function toggleHitbox(enabled)
    CombatModule.Settings.HitboxEnabled = enabled
    
    if enabled then
        if not hitboxConnection then
            hitboxConnection = RunService.Heartbeat:Connect(function()
                pcall(applyHitbox)
            end)
        end
    else
        if hitboxConnection then
            hitboxConnection:Disconnect()
            hitboxConnection = nil
        end
        restoreHitboxes()
    end
end

local function toggleAimlock(enabled)
    CombatModule.Settings.AimlockEnabled = enabled
    
    if enabled then
        createFOVCircle()
        
        if not aimlockConnection then
            aimlockConnection = RunService.RenderStepped:Connect(function()
                pcall(aimlockUpdate)
                pcall(updateFOVCircle)
            end)
        end
    else
        if aimlockConnection then
            aimlockConnection:Disconnect()
            aimlockConnection = nil
        end
        currentTarget = nil
        if fovCircle then
            fovCircle.Visible = false
        end
    end
end

function CombatModule.CreateUI(parent)
    local combatContent = Instance.new("ScrollingFrame")
    combatContent.Name = "CombatContent"
    combatContent.Size = UDim2.new(1, -20, 1, -20)
    combatContent.Position = UDim2.new(0, 10, 0, 10)
    combatContent.BackgroundTransparency = 1
    combatContent.BorderSizePixel = 0
    combatContent.ScrollBarThickness = 4
    combatContent.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
    combatContent.Parent = parent
    
    local yPos = 10
    
    -- Hitbox Section
    local hitboxTitle = Instance.new("TextLabel")
    hitboxTitle.Size = UDim2.new(1, -20, 0, 30)
    hitboxTitle.Position = UDim2.new(0, 10, 0, yPos)
    hitboxTitle.BackgroundTransparency = 1
    hitboxTitle.Text = "HITBOX ADJUSTMENT"
    hitboxTitle.Font = Enum.Font.GothamBlack
    hitboxTitle.TextSize = 16
    hitboxTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    hitboxTitle.TextXAlignment = Enum.TextXAlignment.Left
    hitboxTitle.Parent = combatContent
    yPos = yPos + 40
    
    -- Hitbox Toggle
    local function createToggleButton(name, settingKey, position, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.4, -10, 0, 40)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBold
        label.TextSize = 14
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local toggleButton = Instance.new("TextButton")
        toggleButton.Size = UDim2.new(0, 140, 0, 40)
        toggleButton.Position = UDim2.new(1, -140, 0, 5)
        toggleButton.BackgroundColor3 = Color3.fromRGB(180, 30, 30)
        toggleButton.BorderSizePixel = 0
        toggleButton.Text = "DISABLED"
        toggleButton.Font = Enum.Font.GothamBlack
        toggleButton.TextSize = 14
        toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        toggleButton.AutoButtonColor = false
        toggleButton.Parent = container
        
        toggleButton.MouseButton1Click:Connect(function()
            CombatModule.Settings[settingKey] = not CombatModule.Settings[settingKey]
            
            if CombatModule.Settings[settingKey] then
                toggleButton.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
                toggleButton.Text = "ENABLED"
            else
                toggleButton.BackgroundColor3 = Color3.fromRGB(180, 30, 30)
                toggleButton.Text = "DISABLED"
            end
            
            if callback then callback(CombatModule.Settings[settingKey]) end
        end)
        
        return position + 60
    end
    
    yPos = createToggleButton("Hitbox", "HitboxEnabled", yPos, toggleHitbox)
    
    -- Hitbox Size Sliders
    local function createSlider(name, settingKey, minVal, maxVal, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 100, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. CombatModule.Settings[settingKey]
        label.Font = Enum.Font.GothamBold
        label.TextSize = 12
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, -110, 0, 20)
        sliderBg.Position = UDim2.new(0, 105, 0, 25)
        sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        sliderBg.BorderSizePixel = 1
        sliderBg.BorderColor3 = Color3.fromRGB(255, 255, 255)
        sliderBg.Parent = container
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((CombatModule.Settings[settingKey] - minVal) / (maxVal - minVal), 0, 1, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local sliderButton = Instance.new("TextButton")
        sliderButton.Size = UDim2.new(1, 0, 1, 0)
        sliderButton.BackgroundTransparency = 1
        sliderButton.Text = ""
        sliderButton.Parent = sliderBg
        
        local dragging = false
        
        sliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = UserInputService:GetMouseLocation()
                local relativeX = math.clamp(mouse.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                local percentage = relativeX / sliderBg.AbsoluteSize.X
                local value = math.floor(minVal + (maxVal - minVal) * percentage)
                
                CombatModule.Settings[settingKey] = value
                sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
                label.Text = name .. ": " .. value
            end
        end)
        
        return position + 60
    end
    
    yPos = createSlider("Hitbox X", "HitboxX", 1, 20, yPos)
    yPos = createSlider("Hitbox Y", "HitboxY", 1, 20, yPos)
    yPos = createSlider("Hitbox Z", "HitboxZ", 1, 20, yPos)
    
    -- Checkboxes
    local function createCheckbox(name, settingKey, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 30)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local checkbox = Instance.new("TextButton")
        checkbox.Size = UDim2.new(0, 20, 0, 20)
        checkbox.Position = UDim2.new(0, 0, 0, 5)
        checkbox.BackgroundColor3 = Color3.fromRGB(124, 124, 124)
        checkbox.BackgroundTransparency = 0.3
        checkbox.BorderSizePixel = 1
        checkbox.BorderColor3 = Color3.fromRGB(255, 255, 255)
        checkbox.Text = ""
        checkbox.AutoButtonColor = false
        checkbox.Parent = container
        
        local checkmark = Instance.new("TextLabel")
        checkmark.Size = UDim2.new(1, 0, 1, 0)
        checkmark.BackgroundTransparency = 1
        checkmark.Text = ""
        checkmark.Font = Enum.Font.GothamBlack
        checkmark.TextSize = 16
        checkmark.TextColor3 = Color3.fromRGB(255, 255, 255)
        checkmark.Parent = checkbox
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -30, 0, 30)
        label.Position = UDim2.new(0, 30, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBold
        label.TextSize = 14
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        checkbox.MouseButton1Click:Connect(function()
            CombatModule.Settings[settingKey] = not CombatModule.Settings[settingKey]
            checkmark.Text = CombatModule.Settings[settingKey] and "âœ“" or ""
        end)
        
        return position + 40
    end
    
    yPos = createCheckbox("Visibility Check", "VisibilityCheck", yPos)
    yPos = createCheckbox("Team Check", "TeamCheck", yPos)
    
    yPos = yPos + 10
    
    -- Aimlock Section
    local aimlockTitle = Instance.new("TextLabel")
    aimlockTitle.Size = UDim2.new(1, -20, 0, 30)
    aimlockTitle.Position = UDim2.new(0, 10, 0, yPos)
    aimlockTitle.BackgroundTransparency = 1
    aimlockTitle.Text = "AIMLOCK"
    aimlockTitle.Font = Enum.Font.GothamBlack
    aimlockTitle.TextSize = 16
    aimlockTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    aimlockTitle.TextXAlignment = Enum.TextXAlignment.Left
    aimlockTitle.Parent = combatContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Aimlock", "AimlockEnabled", yPos, toggleAimlock)
    yPos = createSlider("Smoothness", "AimlockSmoothness", 1, 20, yPos)
    yPos = createSlider("FOV Size", "FOVSize", 50, 500, yPos)
    yPos = createCheckbox("Show FOV Circle", "ShowFOV", yPos)
    
    combatContent.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

function CombatModule.Cleanup()
    if hitboxConnection then
        hitboxConnection:Disconnect()
        hitboxConnection = nil
    end
    if aimlockConnection then
        aimlockConnection:Disconnect()
        aimlockConnection = nil
    end
    if fovCircle then
        fovCircle:Remove()
        fovCircle = nil
    end
    restoreHitboxes()
end

return CombatModule

print("loaded")
