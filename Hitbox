-- Hitbox Script - Fresh Start
-- Upload this to GitHub and use the raw link

print("leds")

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Get settings from global
local HitboxSettings = getgenv().HitboxSettings
if not HitboxSettings then
    warn("HitboxSettings not found - load Combat GUI first")
    return
end

local hitboxConnection = nil
local originalHitboxSizes = {}
local previewBox = nil

local function isOnSameTeam(player)
    if not HitboxSettings.TeamCheck then return false end
    if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
        return true
    end
    return false
end

local function createPreviewBox()
    if previewBox then return end
    
    previewBox = Instance.new("Part")
    previewBox.Name = "HitboxPreview"
    previewBox.Anchored = true
    previewBox.CanCollide = false
    previewBox.Material = Enum.Material.ForceField
    previewBox.Color = Color3.fromRGB(255, 0, 0)
    previewBox.Transparency = HitboxSettings.PreviewTransparency
    
    -- Calculate size
    local sizeX = HitboxSettings.HitboxLeft + HitboxSettings.HitboxRight
    local sizeY = HitboxSettings.HitboxUp + HitboxSettings.HitboxDown
    local sizeZ = HitboxSettings.HitboxFront + HitboxSettings.HitboxBack
    previewBox.Size = Vector3.new(math.max(sizeX, 0.5), math.max(sizeY, 0.5), math.max(sizeZ, 0.5))
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = LocalPlayer.Character.HumanoidRootPart
        
        -- Calculate offset
        local offsetX = (HitboxSettings.HitboxRight - HitboxSettings.HitboxLeft) / 2
        local offsetY = (HitboxSettings.HitboxUp - HitboxSettings.HitboxDown) / 2
        local offsetZ = (HitboxSettings.HitboxBack - HitboxSettings.HitboxFront) / 2
        
        previewBox.CFrame = hrp.CFrame * CFrame.new(offsetX, offsetY, offsetZ)
    end
    
    previewBox.Parent = workspace
end

local function updatePreviewBox()
    if not previewBox then return end
    
    -- Update size
    local sizeX = HitboxSettings.HitboxLeft + HitboxSettings.HitboxRight
    local sizeY = HitboxSettings.HitboxUp + HitboxSettings.HitboxDown
    local sizeZ = HitboxSettings.HitboxFront + HitboxSettings.HitboxBack
    previewBox.Size = Vector3.new(math.max(sizeX, 0.5), math.max(sizeY, 0.5), math.max(sizeZ, 0.5))
    previewBox.Transparency = HitboxSettings.PreviewTransparency
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = LocalPlayer.Character.HumanoidRootPart
        
        -- Calculate offset
        local offsetX = (HitboxSettings.HitboxRight - HitboxSettings.HitboxLeft) / 2
        local offsetY = (HitboxSettings.HitboxUp - HitboxSettings.HitboxDown) / 2
        local offsetZ = (HitboxSettings.HitboxBack - HitboxSettings.HitboxFront) / 2
        
        previewBox.CFrame = hrp.CFrame * CFrame.new(offsetX, offsetY, offsetZ)
    end
end

local function removePreviewBox()
    if previewBox then
        previewBox:Destroy()
        previewBox = nil
    end
end

local function applyHitbox()
    if not HitboxSettings.Enabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Skip teammates
            if isOnSameTeam(player) then
                if originalHitboxSizes[player] then
                    local hrp = player.Character:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        hrp.Size = originalHitboxSizes[player]
                        hrp.Transparency = 0
                        hrp.CanCollide = true
                    end
                    originalHitboxSizes[player] = nil
                end
                continue
            end
            
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                -- Store original size
                if not originalHitboxSizes[player] then
                    originalHitboxSizes[player] = hrp.Size
                end
                
                -- Calculate new size
                local sizeX = HitboxSettings.HitboxLeft + HitboxSettings.HitboxRight
                local sizeY = HitboxSettings.HitboxUp + HitboxSettings.HitboxDown
                local sizeZ = HitboxSettings.HitboxFront + HitboxSettings.HitboxBack
                
                -- Apply size
                hrp.Size = Vector3.new(math.max(sizeX, 0.5), math.max(sizeY, 0.5), math.max(sizeZ, 0.5))
                hrp.Transparency = HitboxSettings.HitboxTransparency
                hrp.CanCollide = false
            end
        end
    end
end

local function restoreHitboxes()
    for player, originalSize in pairs(originalHitboxSizes) do
        if player.Character then
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                hrp.Size = originalSize
                hrp.Transparency = 0
                hrp.CanCollide = true
            end
        end
    end
    originalHitboxSizes = {}
end

-- Main loop
local function startHitbox()
    if hitboxConnection then return end
    
    createPreviewBox()
    
    hitboxConnection = RunService.Heartbeat:Connect(function()
        pcall(applyHitbox)
        pcall(updatePreviewBox)
    end)
end

local function stopHitbox()
    if hitboxConnection then
        hitboxConnection:Disconnect()
        hitboxConnection = nil
    end
    removePreviewBox()
    restoreHitboxes()
end

-- Export functions
getgenv().HitboxControl = {
    Start = startHitbox,
    Stop = stopHitbox
}

print("Hitbox Script Loaded!")
return true
