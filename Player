-- Player Module
-- Features: Reset Character, Lock Jumppower, Noclip
-- All ZIndex >= 65, Gotham fonts, black text, F0DCE6 backgrounds

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

local PlayerModule = {}

local LABEL_BG = Color3.fromRGB(240, 220, 230)
local TEXT_COL = Color3.fromRGB(0, 0, 0)
local BTN_OFF = Color3.fromRGB(255, 255, 255)
local BTN_ON = Color3.fromRGB(240, 220, 230)
local SLIDER_BG = Color3.fromRGB(200, 180, 190)
local SLIDER_FILL = Color3.fromRGB(244, 167, 187)
local Z_BG = 66
local Z_TEXT = 67
local Z_BTN = 68
local Z_FILL = 69
local Z_KNOB = 70

-- Settings
getgenv().PlayerSettings = {
    ResetEnabled = false,
    LockJumppower = false,
    JumppowerValue = 50,
    Noclip = false
}

local jumppowerConnection = nil
local noclipConnection = nil

local function enableReset()
    if getgenv().PlayerSettings.ResetEnabled then
        local success = pcall(function()
            local args = {"Damage", math.huge}
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FallDamage"):FireServer(unpack(args))
        end)
        if success then
            print("Reset character via fall damage")
        else
            pcall(function()
                StarterGui:SetCore("ResetButtonCallback", true)
                print("Reset button enabled")
            end)
        end
    end
end

local function lockJumppower()
    if jumppowerConnection then
        jumppowerConnection:Disconnect()
        jumppowerConnection = nil
    end
    if getgenv().PlayerSettings.LockJumppower then
        jumppowerConnection = RunService.Heartbeat:Connect(function()
            if LocalPlayer.Character then
                local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.UseJumpPower = false
                    humanoid.JumpHeight = getgenv().PlayerSettings.JumppowerValue
                end
            end
        end)
        print("Jumppower locked at: " .. getgenv().PlayerSettings.JumppowerValue)
    else
        print("Jumppower unlocked")
    end
end

local function toggleNoclip()
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    if getgenv().PlayerSettings.Noclip then
        noclipConnection = RunService.Stepped:Connect(function()
            if LocalPlayer.Character then
                for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                    if part:IsA("BasePart") and not part:IsDescendantOf(workspace:FindFirstChild("Map") or workspace) then
                        part.CanCollide = false
                    end
                end
            end
        end)
        print("Noclip enabled (excluding Map)")
    else
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end
        print("Noclip disabled")
    end
end

function PlayerModule.CreateUI(parent)
    local playerContent = Instance.new("ScrollingFrame")
    playerContent.Size = UDim2.new(1, 0, 1, 0)
    playerContent.BackgroundTransparency = 1
    playerContent.BorderSizePixel = 0
    playerContent.ScrollBarThickness = 4
    playerContent.ScrollBarImageColor3 = Color3.fromRGB(200, 180, 190)
    playerContent.ZIndex = 65
    playerContent.Parent = parent

    local yPos = 10

    -- Helper: section title with F0DCE6 background
    local function createTitle(text, position)
        local bg = Instance.new("Frame")
        bg.Size = UDim2.new(1, -20, 0, 28)
        bg.Position = UDim2.new(0, 10, 0, position)
        bg.BackgroundColor3 = LABEL_BG
        bg.BorderSizePixel = 0
        bg.ZIndex = Z_BG
        bg.Parent = playerContent

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -8, 1, 0)
        label.Position = UDim2.new(0, 4, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.Font = Enum.Font.GothamBold
        label.TextSize = 15
        label.TextColor3 = TEXT_COL
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.ZIndex = Z_TEXT
        label.Parent = bg

        return position + 38
    end

    -- Helper: toggle button (white off / F0DCE6 on)
    local function createToggleButton(name, settingsTable, settingKey, position, callback)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -20, 0, 35)
        button.Position = UDim2.new(0, 10, 0, position)
        button.BackgroundColor3 = settingsTable[settingKey] and BTN_ON or BTN_OFF
        button.BorderSizePixel = 0
        button.AutoButtonColor = false
        button.Text = settingsTable[settingKey] and name or "DISABLED"
        button.Font = Enum.Font.Gotham
        button.TextSize = 14
        button.TextColor3 = TEXT_COL
        button.ZIndex = Z_BTN
        button.Parent = playerContent

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = button

        button.MouseButton1Click:Connect(function()
            settingsTable[settingKey] = not settingsTable[settingKey]
            TweenService:Create(button, TweenInfo.new(0.15), {
                BackgroundColor3 = settingsTable[settingKey] and BTN_ON or BTN_OFF
            }):Play()
            button.Text = settingsTable[settingKey] and name or "DISABLED"
            if callback then callback(settingsTable[settingKey]) end
        end)

        return position + 45
    end

    -- Helper: slider with F0DCE6 label background
    local function createSlider(name, settingsTable, settingKey, minVal, maxVal, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 55)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.ZIndex = 65
        container.Parent = playerContent

        -- Label with F0DCE6 background
        local labelBg = Instance.new("Frame")
        labelBg.Size = UDim2.new(0, 140, 0, 22)
        labelBg.Position = UDim2.new(0, 0, 0, 2)
        labelBg.BackgroundColor3 = LABEL_BG
        labelBg.BorderSizePixel = 0
        labelBg.ZIndex = Z_BG
        labelBg.Parent = container

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -8, 1, 0)
        label.Position = UDim2.new(0, 4, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. settingsTable[settingKey]
        label.Font = Enum.Font.Gotham
        label.TextSize = 12
        label.TextColor3 = TEXT_COL
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.ZIndex = Z_TEXT
        label.Parent = labelBg

        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, -150, 0, 24)
        sliderBg.Position = UDim2.new(0, 145, 0, 25)
        sliderBg.BackgroundColor3 = SLIDER_BG
        sliderBg.BorderSizePixel = 0
        sliderBg.ZIndex = Z_BTN
        sliderBg.Parent = container

        local sliderCorner = Instance.new("UICorner")
        sliderCorner.CornerRadius = UDim.new(0, 6)
        sliderCorner.Parent = sliderBg

        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((settingsTable[settingKey] - minVal) / (maxVal - minVal), 0, 1, 0)
        sliderFill.BackgroundColor3 = SLIDER_FILL
        sliderFill.BorderSizePixel = 0
        sliderFill.ZIndex = Z_FILL
        sliderFill.Parent = sliderBg

        local fillCorner = Instance.new("UICorner")
        fillCorner.CornerRadius = UDim.new(0, 6)
        fillCorner.Parent = sliderFill

        local sliderButton = Instance.new("TextButton")
        sliderButton.Size = UDim2.new(1, 0, 1, 0)
        sliderButton.BackgroundTransparency = 1
        sliderButton.Text = ""
        sliderButton.ZIndex = Z_KNOB
        sliderButton.Parent = sliderBg

        local dragging = false

        sliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)

        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)

        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = UserInputService:GetMouseLocation()
                local relativeX = math.clamp(mouse.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                local percentage = relativeX / sliderBg.AbsoluteSize.X
                local value = math.floor(minVal + (maxVal - minVal) * percentage)

                settingsTable[settingKey] = value
                sliderFill.Size = UDim2.new((value - minVal) / (maxVal - minVal), 0, 1, 0)
                label.Text = name .. ": " .. value

                if settingKey == "JumppowerValue" and getgenv().PlayerSettings.LockJumppower then
                    lockJumppower()
                end
            end
        end)

        return position + 60
    end

    -- RESET CHARACTER Section
    yPos = createTitle("RESET CHARACTER", yPos)
    yPos = createToggleButton("Enable Reset", getgenv().PlayerSettings, "ResetEnabled", yPos, enableReset)
    yPos = yPos + 10

    -- JUMP HEIGHT Section
    yPos = createTitle("JUMP HEIGHT", yPos)
    yPos = createToggleButton("Lock JumpHeight", getgenv().PlayerSettings, "LockJumppower", yPos, lockJumppower)
    yPos = createSlider("JumpHeight Value", getgenv().PlayerSettings, "JumppowerValue", 1, 200, yPos)
    yPos = yPos + 10

    -- NOCLIP Section
    yPos = createTitle("NOCLIP", yPos)
    yPos = createToggleButton("Noclip", getgenv().PlayerSettings, "Noclip", yPos, toggleNoclip)

    playerContent.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

function PlayerModule.Cleanup()
    if jumppowerConnection then
        jumppowerConnection:Disconnect()
    end
    if noclipConnection then
        noclipConnection:Disconnect()
    end
end

return PlayerModule
